---
name: Build container and push to GCR
on:
  push:
    tags:
    - '*'

env:
  GCP_PROJECT: kubernetes-346019
  REGISTRY: harbor-core.k8s.undependable.cloud/private
  IMAGE_NAME: node-labeler
  USERNAME: admin
  CONTEXT: docker
  CHART_PATH: helm/node-labeler

jobs:
  build-and-push-to-gcr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Get the version and build container
        id: get_tag_name
        run: echo ::set-output name=GIT_TAG_NAME::${GITHUB_REF/refs\/tags\//}
      - uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.USERNAME }}
          password: ${{ secrets.HARBOR_REG_PRIVATE }}
      - uses: docker/build-push-action@v2
        with:
          context: ./${{ env.CONTEXT }}
          file: ./${{ env.CONTEXT }}/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.get_tag_name.outputs.GIT_TAG_NAME }}
      - uses: actions/checkout@v2
      - name: Update image tag
        id: set_tag_name
        run: |
          sed -i "s|v[0-9].[0-9].[0-9].*|${{ steps.get_tag_name.outputs.GIT_TAG_NAME }}|g" ./${{ env.CHART_PATH }}/values.yaml
          sed -i "s|v[0-9].[0-9].[0-9]|${{ steps.get_tag_name.outputs.GIT_TAG_NAME }}|g" ./${{ env.CHART_PATH }}/Chart.yaml
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Automated Change
          commit_options: '--no-verify --signoff'
          commit_user_name: GitHub Actions
          commit_author: Author <github-actions@undependable.cloud>
          create_branch: true
          branch: 'feature/update-tag'
      - uses: ravsamhq/notify-slack-action@master
        if: always()
        with:
          status: ${{ job.status }}
          notification_title: '[GitHub Actions] {workflow} has {status_message}'
          message_format: '{emoji} ${{ github.event.head_commit.author.name }} ${{ github.event.head_commit.message }}'
          footer: 'Repo: <{repo_url}|{repo}>'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}